<style>
    .ui-button {
        line-height: 30px !important;
    }

    .flow-manager-diff-type {
        background-color: #ffffff;
        font-size: large;
        text-decoration: underline;
    }

    #flow-manager-remote-diff-dialog {
        max-height: 94vh !important;
    }

    #flow-manager-remote-diff-dialog table,
    #flow-manager-remote-diff-dialog td,
    #flow-manager-remote-diff-dialog th {
        border: 1pt #3e3e3e solid;
        padding: 5pt;
        white-space: nowrap;
    }

    .flow-manager-remote-diff-field-header {
        font-size: large;
    }
</style>

<script type="text/javascript">
    (async () => {

        // We use this function for ajax and not the jquery one ($.ajax) because on older nodereds, jquery version of this call does not return promise
        function ajax(options) {
            return new Promise(function (resolve, reject) {
                $.ajax(options).done(resolve).fail(reject);
            });
        }

        function paramObj(url) {
            if (url.indexOf('#flow') != -1) url = url.slice(0, url.indexOf('#flow'))
            const search = url.split('?')[1]
            if (!search) { return {} }
            return JSON.parse(
                '{"' +
                decodeURIComponent(search)
                    .replace(/"/g, '\\"')
                    .replace(/&/g, '","')
                    .replace(/=/g, '":"')
                    .replace(/\+/g, ' ') +
                '"}'
            )
        }

        const queryObj = await paramObj(window.location.href)

        let targetJson = null;
        if (queryObj && queryObj.appId) {
            // get the target file
            try {
                const targetUrl = 'https://sensecraft-statics.seeed.cc/mission-pack-test/' + queryObj.appId + '/flow.json';
                const data = await ajax({
                    url: targetUrl,
                    dataType: 'json', // 指定数据类型为JSON
                    method: 'GET',
                    contentType: "application/json; charset=utf-8"
                });
                targetJson = data;
                console.log(data, 'target json')
            } catch (error) {
                alert(`Failed to get the target file (Application Id: ${queryObj.appId}), Discontinuing.`);
                console.log(error)
            }
        }

        if (!targetJson) return false;

        // Add diff popup
        $('body').prepend(`
            <div id="flow-manager-remote-diff-dialog" style="width: auto; text-align: center">
                <div id="flow-manager-remote-no-diff" style="color: darkgreen">No differences were found.</div>
                <div id="flow-manager-remote-diff-controllers">
                    <button id="flow-manager-remote-diff-toggle-all" class="ui-button ui-widget ui-corner-all" href="#">Toggle all actions</button>
                    <br/><br/>

                    <table style="border-color: #7c9cec; border-width: 2px;">
                        <thead style="background-color: #666; color: #fff !important">
                            <tr>
                                <td class="flow-manager-remote-diff-field-header">Action</td>
                                <td class="flow-manager-remote-diff-field-header">Name</td>
                                <td class="flow-manager-remote-diff-field-header">Status</td>
                                <td class="flow-manager-remote-diff-field-header">Modified Time</td>
                                <td class="flow-manager-remote-diff-field-header">Remote Modified Time</td>
                            </tr>
                        </thead>

                        <tbody><tr><td colspan="6" class="flow-manager-diff-type" id="flow-manager-diff-type-flow" style="background:#fff">Flows</td></tr></tbody>
                        <tbody id="flow-manager-diff-flow"></tbody>
                        <tr><td colspan="6" class="flow-manager-diff-type" id="flow-manager-diff-type-subflow">Subflows</td></tr></tbody>
                        <tbody id="flow-manager-diff-subflow"></tbody>
                        <tbody><tr><td colspan="6" class="flow-manager-diff-type" id="flow-manager-diff-type-global">Global</tr></tbody>
                        <tbody id="flow-manager-diff-global"></tbody>
                    </table>
                    <br/><button id="flow-manager-remote-diff-push-button" class="ui-button ui-widget ui-corner-all" href="#" style="background: #3c7eff !important; color: #fff !important">Apply Selected Actions</button>
                </div>
            </div>`);

        $('#flow-manager-remote-diff-toggle-all').click(function () {
            const inputs = $('#flow-manager-remote-diff-dialog input');

            let allSelected = true
            for (const input of inputs) {
                if (!input.checked && !input.disabled) {
                    allSelected = false;
                    break;
                }
            }

            for (const input of inputs) {
                input.checked = !allSelected || input.disabled
            }
        });


        // $('#flow-manager-remote-diff-push-button').click(async function () {
        //     $("#flow-manager-push-progress-dialog").dialog({ title: 'Push in progress...', modal: true });

        //     const inputs = $('#flow-manager-remote-diff-dialog input');
        //     let remoteNameToDeploy = null;
        //     let progress = 0;
        //     for (const input of inputs) {
        //         progress++;
        //         if (!input.checked) continue;

        //         const remoteName = input.getAttribute('data-remoteName');
        //         remoteNameToDeploy = 'remoteName';

        //         const action = input.getAttribute('data-action') // DEPLOY, DELETE, POST
        //         if (action === 'DEPLOY') continue;

        //         const flowType = input.getAttribute('data-flowType');
        //         const flowName = input.getAttribute('data-flowName');
        //         const localMtime = input.getAttribute('data-mtime');

        //         const [localUrl, remoteUrl] = [false, true].map(isRemote => {
        //             let url = `flow-manager/${isRemote ? ('remotes/' + remoteName + '/') : ''}flow-files/`;
        //             if (flowType === 'global') url += flowType;
        //             else {
        //                 url += `${flowType}s/${flowName}`;
        //             }
        //             url += '?mtime=' + localMtime;
        //             return url;
        //         })

        //         try {
        //             $('#flow-manager-push-progress-label').text(`${action}ing ${flowType} ${flowName || ''}`);

        //             await ajax({
        //                 url: remoteUrl,
        //                 ...(action === 'POST' ?
        //                     {
        //                         contentType: "text/plain",
        //                         data: await ajax({ url: localUrl, headers: { accept: 'text/plain' } })
        //                     }
        //                     : {}),
        //                 type: action
        //             });
        //         } catch (e) {
        //             alert(`Failed to ${action} file ${flowType} ${flowName || ''}, Discontinuing.`);
        //             break;
        //         }
        //         $("#flow-manager-push-progress-progressbar").progressbar({ value: (progress / (inputs.length + 1)) * 100 });
        //     }

        //     if (remoteNameToDeploy) {
        //         $('#flow-manager-push-progress-label').text(`Deploying changes to ${remoteNameToDeploy}...`);
        //         try {
        //             await ajax({
        //                 url: `flow-manager/remotes/${remoteNameToDeploy}/states`,
        //                 method: 'POST',
        //                 data: JSON.stringify({ "action": "reloadOnly" }),
        //                 dataType: "json",
        //                 contentType: "application/json; charset=utf-8"
        //             });
        //         } catch (e) { }

        //         $("#flow-manager-push-progress-progressbar").progressbar({ value: 100 });
        //     }

        //     $("#flow-manager-push-progress-dialog").dialog('close');

        //     $("#flow-manager-remote-diff-dialog").dialog('close');
        // });

        function prepareDiffTable(opts) {
            console.log(opts, 'opts')

            let foundDifferencesInAnyType = false;
            ['flow', 'subflow', 'global'].forEach(flowType => {

                let foundDifferencesInThisType = false;

                const rowsContainerElementForType = $(`#flow-manager-diff-${flowType}`);
                rowsContainerElementForType.empty()

                const allFlowFileNamesFromBoth =
                    flowType === 'global' ? ["global"] :
                        new Set([...Object.keys(opts.localState[flowType]), ...Object.keys(opts.remoteState[flowType])]);

                allFlowFileNamesFromBoth.forEach(flowName => {

                    const localFileState = flowType === 'global' ? opts.localState[flowType] : opts.localState[flowType][flowName];
                    const remoteFileState = flowType === 'global' ? opts.remoteState[flowType] : opts.remoteState[flowType][flowName];

                    let status, statusColor, forceChecked = false, isChecked = false, action, actionDesc;
                    if (!localFileState && remoteFileState) {
                        actionDesc = 'add';
                        status = "Missing in local";
                        statusColor = '#8CC020';
                        action = 'POST';
                        forceChecked = false;
                        isChecked = true;
                    } else if (localFileState && !remoteFileState) {
                        // Actions are already available locally and do not need to be operated
                        action = null;
                    } else {
                        // Both have
                        if (localFileState.rev !== remoteFileState.rev) {
                            const localDate = new Date(localFileState.mtime);
                            const remoteDate = new Date(remoteFileState.mtime);
                            if (remoteDate > localDate) {
                                actionDesc = 'update';
                                status = "Remote file is newer";
                                statusColor = '#f5e15b';
                                isChecked = true;
                            } else if (remoteDate < localDate) {
                                actionDesc = 'overwrite ⚠️';
                                status = "Local file is newer"; // "Danger" tell use he will override more recent change
                                statusColor = '#f54646';
                            } else {
                                actionDesc = 'overwrite ⚠️';
                                status = "Different"; // Not sure, just say it is different. should not happen.
                                statusColor = '#ff9b9b';
                            }
                            action = 'POST';
                        } else if (remoteFileState.hasUpdate) {
                            // Remote and Local file are the same, but Remote did not load it yet
                            action = 'DEPLOY';
                            actionDesc = 'deploy';
                            forceChecked = true;
                            status = "Files equal<br/>But not deployed remotely (deploy)<br/>";
                            statusColor = '#c0d6bd';
                        } else {
                            // Equal files: in this case, do not list row
                            action = null;
                        }
                    }

                    if (action) {
                        foundDifferencesInAnyType = true;
                        foundDifferencesInThisType = true;

                        const lMtime = (localFileState && localFileState.mtime) ? new Date(localFileState.mtime).toLocaleString() : '';
                        const rMtime = (remoteFileState && remoteFileState.mtime) ? new Date(remoteFileState.mtime).toLocaleString() : '';

                        const lRev = localFileState ? localFileState.rev : '';
                        const rRev = remoteFileState ? remoteFileState.rev : '';

                        const inputId = `flow-manager-diff-action-${flowType}${flowName ? ('-' + flowName) : ''}`
                        rowsContainerElementForType.append(`
                            <tr ${statusColor ? 'style="background-color: ' + statusColor + '"' : ''}>
                                <td style="text-align: left"><input id="${inputId}" ${forceChecked ? 'disabled' : ''} ${forceChecked || isChecked ? 'checked' : ''} type="checkbox" data-mtime="${lMtime}" data-remoteName="${opts.remoteName}" data-action="${action}" data-flowName="${flowName}" data-flowType="${flowType}"><label for="${inputId}">${actionDesc}</label></td>
                                <td>${flowName}</td>
                                <td>${status}</td>
                                <td onclick="javascript:alert('Local Rev Checksum: ${lRev}')">${lMtime}</td>
                                <td onclick="javascript:alert('Remote Rev Checksum: ${rRev}')">${rMtime}</td>
                            </tr>
                            `)
                    }
                })

                $(`#flow-manager-diff-type-${flowType}`).css('display', foundDifferencesInThisType ? '' : 'none');

            })

            $('#flow-manager-remote-diff-dialog').dialog({
                title: `Please select the actions to apply to your Node-RED`,
                height: 'auto', width: 'auto'
            });


            $('#flow-manager-remote-diff-controllers').css('display', foundDifferencesInAnyType ? '' : 'none')
            $('#flow-manager-remote-no-diff').css('display', foundDifferencesInAnyType ? 'none' : '')
            if (!foundDifferencesInAnyType) $("#flow-manager-remote-diff-dialog").dialog('close');
        }


        const progressDialog = $("#flow-manager-push-progress-dialog");
        const progressLabel = $('#flow-manager-push-progress-label');
        const progressBar = $('#flow-manager-push-progress-progressbar');

        progressDialog.dialog({ title: 'Loading & Comparing states', modal: true });
        progressLabel.text('');
        progressBar.progressbar({ value: 0 });

        try {
            progressLabel.text('Retrieving Local State');
            const localState = await ajax({ url: 'flow-manager/states/' });
            progressBar.progressbar({ value: 50 });

            progressLabel.text('Retrieving Remote State');
            try {
                const remoteState = await ajax({
                    url: `flow-manager/applicaiton/sate/${queryObj.appId}`,
                    method: 'POST',
                    data: JSON.stringify(targetJson),
                    contentType: 'application/json',
                });
                $('#flow-manager-remote-dialog').dialog('close');

                progressBar.progressbar({ value: 100 });

                prepareDiffTable({
                    localState,
                    remoteState
                });
            } catch (e) {
                alert(`Failed to retrieve flow state from ${queryObj.appId}`);
            }
        } catch (e) {
            alert(`Failed to retrieve local flow state`);
        }

        progressDialog.dialog('close');

    })()
</script>